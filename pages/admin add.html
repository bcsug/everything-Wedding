<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Vendor Management</title>
    
    <!-- Firebase SDK -->
   <script type="module">
    // Import Firebase configuration (same as vendors page)
    import { db, storage } from '../firebase-config.js';
    import { 
        collection, getDocs, addDoc, updateDoc, deleteDoc, doc, serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";
    import { 
        ref, uploadBytes, getDownloadURL 
    } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-storage.js";

    // Make Firebase available globally
    window.firebase = {
        db, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, serverTimestamp,
        storage, ref, uploadBytes, getDownloadURL
    };

    console.log("Firebase initialized successfully for admin");
    
    // Show login immediately (remove the complex auth check)
    document.getElementById('auth-overlay').style.display = 'flex';
</script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #6b5b95;
            --secondary-color: #4a6b88;
            --accent-color: #4fc3f7;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            margin: 0;
            padding: 0;
        }
        
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .auth-container {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        
        .sidebar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            height: 100vh;
            position: fixed;
            width: 250px;
            transition: all 0.3s;
        }
        
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 0.75rem 1.5rem;
            margin: 0.25rem 0;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            color: white;
            background-color: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }
        
        .sidebar .nav-link i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        .main-content {
            margin-left: 250px;
            padding: 20px;
            transition: all 0.3s;
        }
        
        .card {
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            border: none;
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }
        
        .card-header {
            background: white;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            font-weight: 600;
            padding: 1.25rem;
            border-radius: 15px 15px 0 0 !important;
        }
        
        .badge-paid {
            background: linear-gradient(135deg, var(--success-color), #20c997);
        }
        
        .badge-pending {
            background: linear-gradient(135deg, var(--warning-color), #fd7e14);
        }
        
        .badge-featured {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        }
        
        .vendor-logo {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        
        .preview-image {
            max-width: 100%;
            max-height: 150px;
            object-fit: cover;
            border-radius: 8px;
            margin: 5px;
            border: 2px solid #e9ecef;
        }
        
        .image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .image-upload-btn {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        
        .image-upload-btn input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .stats-card {
            text-align: center;
            padding: 1.5rem;
        }
        
        .stats-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        
        .stats-label {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .table-responsive {
            overflow-x: auto;
        }
        
        .table th {
            border-top: none;
            font-weight: 600;
            color: #495057;
            background: #f8f9fa;
        }
        
        .action-buttons .btn {
            margin: 0 2px;
            border-radius: 6px;
        }
        
        .form-control, .form-select {
            border-radius: 8px;
            border: 2px solid #e9ecef;
            padding: 0.75rem;
            transition: all 0.3s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(107, 91, 149, 0.25);
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 80px;
                overflow: hidden;
            }
            
            .sidebar .nav-link span {
                display: none;
            }
            
            .sidebar .nav-link i {
                margin-right: 0;
                font-size: 1.2rem;
            }
            
            .main-content {
                margin-left: 80px;
            }
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(107, 91, 149, 0.3);
        }
        
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #6b5b95;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Authentication Overlay -->
    <div id="auth-overlay" class="auth-overlay" style="display: none;">
        <div class="auth-container">
            <div class="loading-spinner"></div>
            <h4 class="mt-3">Checking Admin Access...</h4>
            <p class="text-muted">Please wait while we verify your permissions.</p>
        </div>
    </div>

    <div class="d-flex">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="p-3 text-center">
                <h4 class="mb-4">Admin Panel</h4>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="#">
                            <i class="fas fa-users"></i>
                            <span>Vendor Management</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <i class="fas fa-money-bill-wave"></i>
                            <span>Payments</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <i class="fas fa-chart-bar"></i>
                            <span>Analytics</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <i class="fas fa-cog"></i>
                            <span>Settings</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html">
                            <i class="fas fa-home"></i>
                            <span>View Site</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="logout-btn">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Logout</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="container-fluid">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="mb-0">Vendor Management</h2>
                    <div class="btn-group">
                        <button class="btn btn-outline-primary" onclick="exportVendors()">
                            <i class="fas fa-download"></i> Export
                        </button>
                        <button class="btn btn-primary" id="toggleVendorForm">
                            <i class="fas fa-plus"></i> Add New Vendor
                        </button>
                    </div>
                </div>
                
                <!-- Quick Stats -->
                <div class="quick-stats">
                    <div class="card stats-card">
                        <div class="stats-number" id="total-vendors">0</div>
                        <div class="stats-label">Total Vendors</div>
                    </div>
                    <div class="card stats-card">
                        <div class="stats-number" id="paid-vendors">0</div>
                        <div class="stats-label">Paid Vendors</div>
                    </div>
                    <div class="card stats-card">
                        <div class="stats-number" id="featured-vendors">0</div>
                        <div class="stats-label">Featured</div>
                    </div>
                    <div class="card stats-card">
                        <div class="stats-number" id="pending-vendors">0</div>
                        <div class="stats-label">Pending</div>
                    </div>
                </div>

                <!-- Add Vendor Form -->
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Add New Vendor</h5>
                                <button class="btn btn-sm btn-outline-secondary" id="toggleVendorFormBtn">
                                    <i class="fas fa-times"></i> Close
                                </button>
                            </div>
                            <div class="card-body" id="vendorFormContainer" style="display: none;">
                                <form id="vendorForm">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="vendorName" class="form-label">Vendor Name *</label>
                                                <input type="text" class="form-control" id="vendorName" required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="vendorCategory" class="form-label">Category *</label>
                                                <select class="form-select" id="vendorCategory" required>
                                                    <option value="">Select Category</option>
                                                    <option value="Photography">Photography</option>
                                                    <option value="Catering">Catering</option>
                                                    <option value="Venue">Venue</option>
                                                    <option value="Florist">Florist</option>
                                                    <option value="Music">Music & Entertainment</option>
                                                    <option value="Cake">Wedding Cakes</option>
                                                    <option value="Transportation">Transportation</option>
                                                    <option value="Beauty">Beauty & Hair</option>
                                                    <option value="Attire">Wedding Attire</option>
                                                    <option value="Jewelry">Jewelry</option>
                                                    <option value="Planner">Wedding Planner</option>
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label for="vendorEmail" class="form-label">Email *</label>
                                                <input type="email" class="form-control" id="vendorEmail" required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="vendorPhone" class="form-label">Phone/Location *</label>
                                                <input type="text" class="form-control" id="vendorPhone" required>
                                                <small class="text-muted">This will be displayed as the vendor's location on the website</small>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="vendorWebsite" class="form-label">Website</label>
                                                <input type="url" class="form-control" id="vendorWebsite" placeholder="https://...">
                                            </div>
                                            <div class="mb-3">
                                                <label for="vendorPrice" class="form-label">Price Range *</label>
                                                <select class="form-select" id="vendorPrice" required>
                                                    <option value="">Select Price Range</option>
                                                    <option value="50">$ - Budget Friendly</option>
                                                    <option value="200">$$ - Moderate</option>
                                                    <option value="500">$$$ - Premium</option>
                                                    <option value="1000">$$$$ - Luxury</option>
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label for="vendorRating" class="form-label">Rating</label>
                                                <select class="form-select" id="vendorRating">
                                                    <option value="4.9">4.9 ★★★★★</option>
                                                    <option value="4.7">4.7 ★★★★☆</option>
                                                    <option value="4.5">4.5 ★★★★☆</option>
                                                    <option value="4.3">4.3 ★★★★☆</option>
                                                    <option value="4.0">4.0 ★★★★☆</option>
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Vendor Status</label>
                                                <div class="d-flex gap-3">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="radio" name="vendorStatus" id="statusActive" value="active" checked>
                                                        <label class="form-check-label" for="statusActive">
                                                            Active
                                                        </label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="radio" name="vendorStatus" id="statusInactive" value="inactive">
                                                        <label class="form-check-label" for="statusInactive">
                                                            Inactive
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Featured Vendor</label>
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="featuredVendor">
                                                    <label class="form-check-label" for="featuredVendor">
                                                        Mark as Featured
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="vendorLogo" class="form-label">Logo</label>
                                                <div class="image-upload-btn">
                                                    <button type="button" class="btn btn-outline-secondary w-100">
                                                        <i class="fas fa-upload"></i> Upload Logo
                                                    </button>
                                                    <input type="file" id="vendorLogo" accept="image/*" class="form-control">
                                                </div>
                                                <div class="mt-2 text-center">
                                                    <img id="logoPreview" src="" alt="Logo Preview" class="vendor-logo" style="display: none;">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="vendorImages" class="form-label">Gallery Images</label>
                                                <div class="image-upload-btn">
                                                    <button type="button" class="btn btn-outline-secondary w-100">
                                                        <i class="fas fa-images"></i> Upload Gallery Images
                                                    </button>
                                                    <input type="file" id="vendorImages" accept="image/*" multiple class="form-control">
                                                </div>
                                                <div class="image-preview-container" id="galleryPreview"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="mb-3">
                                                <label for="vendorDescription" class="form-label">Description *</label>
                                                <textarea class="form-control" id="vendorDescription" rows="4" placeholder="Describe the vendor's services, expertise, and what makes them special..." required></textarea>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Payment Status</label>
                                                <div class="d-flex gap-3">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="radio" name="paymentStatus" id="paidStatus" value="paid" checked>
                                                        <label class="form-check-label" for="paidStatus">
                                                            Paid
                                                        </label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="radio" name="paymentStatus" id="pendingStatus" value="pending">
                                                        <label class="form-check-label" for="pendingStatus">
                                                            Pending
                                                        </label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="radio" name="paymentStatus" id="overdueStatus" value="overdue">
                                                        <label class="form-check-label" for="overdueStatus">
                                                            Overdue
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="vendorExperience" class="form-label">Years of Experience</label>
                                                <input type="number" class="form-control" id="vendorExperience" min="0" max="50" value="5">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="d-flex justify-content-end gap-2">
                                        <button type="button" class="btn btn-secondary" id="cancelVendorForm">Cancel</button>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save"></i> Save Vendor
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vendors List -->
                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Vendors List</h5>
                                <div class="input-group" style="width: 300px;">
                                    <input type="text" class="form-control" placeholder="Search vendors..." id="searchVendors">
                                    <button class="btn btn-outline-secondary" type="button" onclick="filterVendors()">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Logo</th>
                                                <th>Name</th>
                                                <th>Category</th>
                                                <th>Status</th>
                                                <th>Price</th>
                                                <th>Payment</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="vendorsTableBody">
                                            <tr>
                                                <td colspan="7" class="text-center py-4">
                                                    <div class="loading-spinner"></div>
                                                    <p class="mt-2">Loading vendors...</p>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <nav aria-label="Page navigation">
                                    <ul class="pagination justify-content-center" id="pagination">
                                        <!-- Pagination will be loaded here -->
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Vendor Details Modal -->
    <div class="modal fade" id="vendorDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="vendorModalTitle">Vendor Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="vendorModalBody">
                    <!-- Vendor details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="editVendorBtn">Edit</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Wait for Firebase to be available
        let firebaseInitialized = false;
        const checkFirebase = setInterval(() => {
            if (window.firebase) {
                clearInterval(checkFirebase);
                firebaseInitialized = true;
                checkAdminAccess();
            }
        }, 100);

        function checkAdminAccess() {
            const authOverlay = document.getElementById('auth-overlay');
            authOverlay.style.display = 'flex';

            // Simple username/password check
            authOverlay.innerHTML = `
                <div class="auth-container">
                    <i class="fas fa-lock fa-3x text-primary mb-3"></i>
                    <h4>Admin Login Required</h4>
                    <div class="mb-3">
                        <label for="admin-username" class="form-label">Username</label>
                        <input type="text" class="form-control" id="admin-username" placeholder="Enter username">
                    </div>
                    <div class="mb-3">
                        <label for="admin-password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="admin-password" placeholder="Enter password">
                    </div>
                    <div class="alert alert-danger mb-3" id="login-error" style="display: none;">
                        Invalid username or password
                    </div>
                    <button class="btn btn-primary w-100" onclick="attemptLogin()">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>
                    <p class="text-muted mt-3 small">
                        Use: <strong>Tommy</strong> / <strong>Admin</strong>
                    </p>
                </div>
            `;
        }

        function attemptLogin() {
            const username = document.getElementById('admin-username').value;
            const password = document.getElementById('admin-password').value;
            const errorDiv = document.getElementById('login-error');

            if (username === 'Tommy' && password === 'Admin') {
                // Successful login
                document.getElementById('auth-overlay').style.display = 'none';
                initializeApp();
            } else {
                // Failed login
                errorDiv.style.display = 'block';
            }
        }

        function initializeApp() {
            // Firebase modules
            const { 
                db, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, serverTimestamp,
                storage, ref, uploadBytes, getDownloadURL, auth
            } = window.firebase;

            // DOM Elements
            const vendorForm = document.getElementById('vendorForm');
            const vendorFormContainer = document.getElementById('vendorFormContainer');
            const toggleVendorFormBtn = document.getElementById('toggleVendorForm');
            const toggleVendorFormCloseBtn = document.getElementById('toggleVendorFormBtn');
            const cancelVendorFormBtn = document.getElementById('cancelVendorForm');
            const vendorLogoInput = document.getElementById('vendorLogo');
            const logoPreview = document.getElementById('logoPreview');
            const vendorImagesInput = document.getElementById('vendorImages');
            const galleryPreview = document.getElementById('galleryPreview');
            const vendorsTableBody = document.getElementById('vendorsTableBody');
            const searchVendorsInput = document.getElementById('searchVendors');
            const vendorDetailsModal = new bootstrap.Modal(document.getElementById('vendorDetailsModal'));
            const logoutBtn = document.getElementById('logout-btn');
            
            // Variables
            let currentVendorId = null;
            let logoFile = null;
            let galleryFiles = [];
            let vendors = [];
            let currentPage = 1;
            const vendorsPerPage = 10;
            
            // Event Listeners
            toggleVendorFormBtn.addEventListener('click', toggleVendorForm);
            toggleVendorFormCloseBtn.addEventListener('click', toggleVendorForm);
            cancelVendorFormBtn.addEventListener('click', resetVendorForm);
            vendorForm.addEventListener('submit', saveVendor);
            vendorLogoInput.addEventListener('change', handleLogoUpload);
            vendorImagesInput.addEventListener('change', handleGalleryUpload);
            searchVendorsInput.addEventListener('input', filterVendors);
            logoutBtn.addEventListener('click', handleLogout);
            
            // Initialize the page
            document.addEventListener('DOMContentLoaded', () => {
                loadVendors();
            });
            
            // Functions
            function toggleVendorForm() {
                if (vendorFormContainer.style.display === 'none') {
                    vendorFormContainer.style.display = 'block';
                    toggleVendorFormCloseBtn.innerHTML = '<i class="fas fa-times"></i> Close';
                } else {
                    vendorFormContainer.style.display = 'none';
                    toggleVendorFormCloseBtn.innerHTML = '<i class="fas fa-plus"></i> Add New Vendor';
                    resetVendorForm();
                }
            }
            
            function resetVendorForm() {
                vendorForm.reset();
                logoPreview.style.display = 'none';
                galleryPreview.innerHTML = '';
                logoFile = null;
                galleryFiles = [];
                currentVendorId = null;
                document.querySelector('input[name="vendorStatus"][value="active"]').checked = true;
                document.querySelector('input[name="paymentStatus"][value="paid"]').checked = true;
                document.querySelector('button[type="submit"]').innerHTML = '<i class="fas fa-save"></i> Save Vendor';
            }
            
            function handleLogoUpload(e) {
                const file = e.target.files[0];
                if (file) {
                    logoFile = file;
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        logoPreview.src = event.target.result;
                        logoPreview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            }
            
            function handleGalleryUpload(e) {
                galleryFiles = Array.from(e.target.files);
                galleryPreview.innerHTML = '';
                
                galleryFiles.forEach(file => {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const img = document.createElement('img');
                            img.src = event.target.result;
                            img.classList.add('preview-image');
                            galleryPreview.appendChild(img);
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
            
            async function saveVendor(e) {
                e.preventDefault();
                
                const vendorData = {
    name: document.getElementById('vendorName').value,
    category: document.getElementById('vendorCategory').value,
    email: document.getElementById('vendorEmail').value,
    phone: document.getElementById('vendorPhone').value,
    website: document.getElementById('vendorWebsite').value,
    description: document.getElementById('vendorDescription').value,
    price: parseFloat(document.getElementById('vendorPrice').value),
    rating: parseFloat(document.getElementById('vendorRating').value),
    experience: parseInt(document.getElementById('vendorExperience').value),
    status: document.querySelector('input[name="vendorStatus"]:checked').value,
    paymentStatus: document.querySelector('input[name="paymentStatus"]:checked').value,
    isPremium: document.getElementById('featuredVendor').checked,
    isApproved: true, // ← THIS IS CRITICAL for vendors to show up
    createdAt: serverTimestamp(),
    updatedAt: serverTimestamp(),
    location: document.getElementById('vendorPhone').value
};
                
                try {
                    // Upload logo if exists
                    if (logoFile) {
                        const logoRef = ref(storage, `vendor-logos/${Date.now()}-${logoFile.name}`);
                        await uploadBytes(logoRef, logoFile);
                        vendorData.logoUrl = await getDownloadURL(logoRef);
                    }
                    
                    // Upload gallery images if exist
                    if (galleryFiles.length > 0) {
                        const galleryUrls = [];
                        for (const file of galleryFiles) {
                            const imageRef = ref(storage, `vendor-gallery/${Date.now()}-${file.name}`);
                            await uploadBytes(imageRef, file);
                            const url = await getDownloadURL(imageRef);
                            galleryUrls.push(url);
                        }
                        vendorData.gallery = galleryUrls;
                    }
                    
                    // Save vendor data to Firestore
                    if (currentVendorId) {
                        // Update existing vendor
                        await updateDoc(doc(db, 'vendors', currentVendorId), vendorData);
                        showAlert('Vendor updated successfully!', 'success');
                    } else {
                        // Add new vendor
                        await addDoc(collection(db, 'vendors'), vendorData);
                        showAlert('Vendor added successfully!', 'success');
                    }
                    
                    resetVendorForm();
                    toggleVendorForm();
                    loadVendors();
                    
                } catch (error) {
                    console.error("Error saving vendor:", error);
                    showAlert("Failed to save vendor. Please try again.", 'error');
                }
            }
            
            async function loadVendors() {
                try {
                    const querySnapshot = await getDocs(collection(db, 'vendors'));
                    vendors = [];
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        vendors.push({
                            id: doc.id,
                            name: data.name || 'Vendor',
                            category: data.category || 'General',
                            email: data.email || '',
                            phone: data.phone || '',
                            website: data.website || '',
                            description: data.description || '',
                            price: data.price || 0,
                            rating: data.rating || 4.5,
                            experience: data.experience || 5,
                            status: data.status || 'active',
                            paymentStatus: data.paymentStatus || 'pending',
                            isPremium: data.isPremium || false,
                            logoUrl: data.logoUrl || '',
                            gallery: data.gallery || [],
                            createdAt: data.createdAt || new Date()
                        });
                    });
                    
                    console.log(`Loaded ${vendors.length} vendors from database`);
                    
                    renderVendorsTable();
                    renderPagination();
                    updateStats();
                } catch (error) {
                    console.error("Error loading vendors:", error);
                    showAlert("Failed to load vendors: " + error.message, 'error');
                    vendorsTableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center py-4 text-danger">
                                <i class="fas fa-exclamation-triangle"></i>
                                Failed to load vendors. Please check your connection.
                            </td>
                        </tr>
                    `;
                }
            }
            
            function renderVendorsTable(filteredVendors = null) {
                const vendorsToDisplay = filteredVendors || vendors;
                const startIndex = (currentPage - 1) * vendorsPerPage;
                const endIndex = startIndex + vendorsPerPage;
                const paginatedVendors = vendorsToDisplay.slice(startIndex, endIndex);
                
                vendorsTableBody.innerHTML = '';
                
                if (paginatedVendors.length === 0) {
                    vendorsTableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center py-4">
                                <i class="fas fa-search"></i>
                                No vendors found. Add your first vendor above.
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                paginatedVendors.forEach(vendor => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            ${vendor.logoUrl ? 
                                `<img src="${vendor.logoUrl}" alt="${vendor.name} Logo" class="vendor-logo">` : 
                                '<i class="fas fa-store-alt fa-2x text-muted"></i>'}
                        </td>
                        <td>
                            <strong>${vendor.name}</strong>
                            ${vendor.isPremium ? '<span class="badge badge-featured ms-1">Featured</span>' : ''}
                        </td>
                        <td>${vendor.category}</td>
                        <td>
                            <span class="badge rounded-pill ${vendor.status === 'active' ? 'bg-success' : 'bg-secondary'}">
                                ${vendor.status === 'active' ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td>${formatPriceRange(vendor.price)}</td>
                        <td>
                            <span class="badge rounded-pill ${getPaymentBadgeClass(vendor.paymentStatus)}">
                                ${vendor.paymentStatus.charAt(0).toUpperCase() + vendor.paymentStatus.slice(1)}
                            </span>
                        </td>
                        <td class="action-buttons">
                            <button class="btn btn-sm btn-outline-primary view-vendor" data-id="${vendor.id}">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-warning edit-vendor" data-id="${vendor.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger delete-vendor" data-id="${vendor.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    vendorsTableBody.appendChild(row);
                });
                
                // Add event listeners to the buttons
                document.querySelectorAll('.view-vendor').forEach(btn => {
                    btn.addEventListener('click', viewVendorDetails);
                });
                
                document.querySelectorAll('.edit-vendor').forEach(btn => {
                    btn.addEventListener('click', editVendor);
                });
                
                document.querySelectorAll('.delete-vendor').forEach(btn => {
                    btn.addEventListener('click', deleteVendor);
                });
            }
            
            function formatPriceRange(price) {
                if (!price) return 'N/A';
                const priceNum = parseFloat(price);
                if (priceNum < 100) return '$';
                if (priceNum < 500) return '$$';
                if (priceNum < 1000) return '$$$';
                return '$$$$';
            }
            
            function getPaymentBadgeClass(status) {
                switch (status) {
                    case 'paid': return 'bg-success';
                    case 'pending': return 'bg-warning text-dark';
                    case 'overdue': return 'bg-danger';
                    default: return 'bg-secondary';
                }
            }
            
            function renderPagination(filteredVendors = null) {
                const vendorsToPaginate = filteredVendors || vendors;
                const totalPages = Math.ceil(vendorsToPaginate.length / vendorsPerPage);
                const pagination = document.getElementById('pagination');
                
                pagination.innerHTML = '';
                
                if (totalPages <= 1) return;
                
                // Previous button
                const prevLi = document.createElement('li');
                prevLi.classList.add('page-item', currentPage === 1 ? 'disabled' : '');
                prevLi.innerHTML = `<a class="page-link" href="#" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>`;
                prevLi.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (currentPage > 1) {
                        currentPage--;
                        renderVendorsTable(filteredVendors);
                        renderPagination(filteredVendors);
                    }
                });
                pagination.appendChild(prevLi);
                
                // Page numbers
                for (let i = 1; i <= totalPages; i++) {
                    const pageLi = document.createElement('li');
                    pageLi.classList.add('page-item', currentPage === i ? 'active' : '');
                    pageLi.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                    pageLi.addEventListener('click', (e) => {
                        e.preventDefault();
                        currentPage = i;
                        renderVendorsTable(filteredVendors);
                        renderPagination(filteredVendors);
                    });
                    pagination.appendChild(pageLi);
                }
                
                // Next button
                const nextLi = document.createElement('li');
                nextLi.classList.add('page-item', currentPage === totalPages ? 'disabled' : '');
                nextLi.innerHTML = `<a class="page-link" href="#" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>`;
                nextLi.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (currentPage < totalPages) {
                        currentPage++;
                        renderVendorsTable(filteredVendors);
                        renderPagination(filteredVendors);
                    }
                });
                pagination.appendChild(nextLi);
            }
            
            function filterVendors() {
                const searchTerm = searchVendorsInput.value.toLowerCase();
                if (!searchTerm) {
                    renderVendorsTable();
                    renderPagination();
                    return;
                }
                
                const filtered = vendors.filter(vendor => 
                    vendor.name.toLowerCase().includes(searchTerm) || 
                    vendor.category.toLowerCase().includes(searchTerm) ||
                    vendor.email.toLowerCase().includes(searchTerm)
                );
                
                currentPage = 1;
                renderVendorsTable(filtered);
                renderPagination(filtered);
            }
            
            async function viewVendorDetails(e) {
                const vendorId = e.currentTarget.getAttribute('data-id');
                const vendor = vendors.find(v => v.id === vendorId);
                
                if (vendor) {
                    document.getElementById('vendorModalTitle').textContent = vendor.name;
                    
                    let galleryHtml = '';
                    if (vendor.gallery && vendor.gallery.length > 0) {
                        galleryHtml = `
                            <div class="mt-3">
                                <h6>Gallery</h6>
                                <div class="d-flex flex-wrap gap-2">
                                    ${vendor.gallery.map(img => `<img src="${img}" class="preview-image">`).join('')}
                                </div>
                            </div>
                        `;
                    }
                    
                    document.getElementById('vendorModalBody').innerHTML = `
                        <div class="row">
                            <div class="col-md-4 text-center">
                                ${vendor.logoUrl ? 
                                    `<img src="${vendor.logoUrl}" alt="${vendor.name} Logo" class="vendor-logo mb-3">` : 
                                    '<i class="fas fa-store-alt fa-5x text-muted mb-3"></i>'}
                                <h4>${vendor.name}</h4>
                                <span class="badge rounded-pill ${vendor.status === 'active' ? 'bg-success' : 'bg-secondary'}">
                                    ${vendor.status === 'active' ? 'Active' : 'Inactive'}
                                </span>
                                ${vendor.isPremium ? '<span class="badge badge-featured ms-1">Featured</span>' : ''}
                            </div>
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <h6>Category</h6>
                                    <p>${vendor.category}</p>
                                </div>
                                <div class="mb-3">
                                    <h6>Contact Information</h6>
                                    <p><strong>Email:</strong> ${vendor.email}</p>
                                    <p><strong>Phone/Location:</strong> ${vendor.phone}</p>
                                    <p><strong>Website:</strong> ${vendor.website || 'N/A'}</p>
                                </div>
                                <div class="mb-3">
                                    <h6>Pricing & Rating</h6>
                                    <p><strong>Price Range:</strong> ${formatPriceRange(vendor.price)}</p>
                                    <p><strong>Rating:</strong> ${vendor.rating} ★</p>
                                    <p><strong>Experience:</strong> ${vendor.experience || '5'}+ years</p>
                                </div>
                                <div class="mb-3">
                                    <h6>Payment Status</h6>
                                    <span class="badge rounded-pill ${getPaymentBadgeClass(vendor.paymentStatus)}">
                                        ${vendor.paymentStatus.charAt(0).toUpperCase() + vendor.paymentStatus.slice(1)}
                                    </span>
                                </div>
                                <div class="mb-3">
                                    <h6>Description</h6>
                                    <p>${vendor.description}</p>
                                </div>
                                ${galleryHtml}
                            </div>
                        </div>
                    `;
                    
                    currentVendorId = vendorId;
                    vendorDetailsModal.show();
                }
            }
            
            function editVendor(e) {
                const vendorId = e.currentTarget.getAttribute('data-id');
                const vendor = vendors.find(v => v.id === vendorId);
                
                if (vendor) {
                    // Populate form with vendor data
                    document.getElementById('vendorName').value = vendor.name;
                    document.getElementById('vendorCategory').value = vendor.category;
                    document.getElementById('vendorEmail').value = vendor.email;
                    document.getElementById('vendorPhone').value = vendor.phone;
                    document.getElementById('vendorWebsite').value = vendor.website || '';
                    document.getElementById('vendorPrice').value = vendor.price;
                    document.getElementById('vendorRating').value = vendor.rating;
                    document.getElementById('vendorExperience').value = vendor.experience || 5;
                    document.getElementById('vendorDescription').value = vendor.description;
                    
                    // Set status radio buttons
                    document.querySelector(`input[name="vendorStatus"][value="${vendor.status}"]`).checked = true;
                    document.querySelector(`input[name="paymentStatus"][value="${vendor.paymentStatus}"]`).checked = true;
                    
                    // Set featured checkbox
                    document.getElementById('featuredVendor').checked = vendor.isPremium || false;
                    
                    // Handle images
                    if (vendor.logoUrl) {
                        logoPreview.src = vendor.logoUrl;
                        logoPreview.style.display = 'block';
                    }
                    
                    // Show form and set current vendor ID
                    currentVendorId = vendorId;
                    vendorFormContainer.style.display = 'block';
                    document.querySelector('button[type="submit"]').innerHTML = '<i class="fas fa-save"></i> Update Vendor';
                    
                    // Scroll to form
                    vendorFormContainer.scrollIntoView({ behavior: 'smooth' });
                }
            }
            
            async function deleteVendor(e) {
                const vendorId = e.currentTarget.getAttribute('data-id');
                const vendor = vendors.find(v => v.id === vendorId);
                
                if (!confirm(`Are you sure you want to delete "${vendor.name}"? This action cannot be undone.`)) return;
                
                try {
                    await deleteDoc(doc(db, 'vendors', vendorId));
                    showAlert('Vendor deleted successfully!', 'success');
                    loadVendors();
                } catch (error) {
                    console.error("Error deleting vendor:", error);
                    showAlert("Failed to delete vendor.", 'error');
                }
            }
            
            function updateStats() {
                const totalVendors = vendors.length;
                const paidVendors = vendors.filter(v => v.paymentStatus === 'paid').length;
                const featuredVendors = vendors.filter(v => v.isPremium).length;
                const pendingVendors = vendors.filter(v => v.paymentStatus === 'pending').length;
                
                document.getElementById('total-vendors').textContent = totalVendors;
                document.getElementById('paid-vendors').textContent = paidVendors;
                document.getElementById('featured-vendors').textContent = featuredVendors;
                document.getElementById('pending-vendors').textContent = pendingVendors;
            }
            
            function showAlert(message, type) {
                // Create alert element
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type === 'error' ? 'danger' : 'success'} alert-dismissible fade show`;
                alertDiv.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                // Add to page
                document.querySelector('.main-content').insertBefore(alertDiv, document.querySelector('.container-fluid'));
                
                // Auto remove after 5 seconds
                setTimeout(() => {
                    if (alertDiv.parentElement) {
                        alertDiv.remove();
                    }
                }, 5000);
            }
            
            function exportVendors() {
                // Simple CSV export
                const headers = ['Name', 'Category', 'Email', 'Phone', 'Website', 'Price', 'Rating', 'Status', 'Payment Status'];
                const csvData = vendors.map(vendor => [
                    vendor.name,
                    vendor.category,
                    vendor.email,
                    vendor.phone,
                    vendor.website || '',
                    vendor.price,
                    vendor.rating,
                    vendor.status,
                    vendor.paymentStatus
                ]);
                
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += headers.join(',') + "\n";
                csvData.forEach(row => {
                    csvContent += row.join(',') + "\n";
                });
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "vendors_export.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            async function handleLogout() {
                try {
                    await auth.signOut();
                    window.location.href = '../pages/login.html';
                } catch (error) {
                    console.error("Error signing out:", error);
                }
            }

            // Initialize edit button in modal
            document.getElementById('editVendorBtn').addEventListener('click', () => {
                vendorDetailsModal.hide();
                if (currentVendorId) {
                    const editButton = document.querySelector(`.edit-vendor[data-id="${currentVendorId}"]`);
                    if (editButton) {
                        editButton.click();
                    }
                }
            });
        }
    </script>
</body>
</html>